#include "Parser/Stmts.hpp"

namespace sc
{
///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtBlock ////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtBlock::clone(Context &ctx)
{
	Vector<Stmt *> newstmts;
	for(auto &stmt : stmts) {
		newstmts.push_back(stmt->clone(ctx));
	}
	Stmt *res = StmtBlock::create(ctx, getLoc(), newstmts, is_top, disable_layering);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtType /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtType::clone(Context &ctx)
{
	Stmt *res = StmtType::create(ctx, getLoc(), ptr, variadic, expr->clone(ctx));
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// StmtSimple /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtSimple::clone(Context &ctx)
{
	StmtSimple *newsim	  = StmtSimple::create(ctx, getLoc(), val);
	newsim->self		  = self ? self->clone(ctx) : nullptr;
	newsim->applied_module_id = applied_module_id;
	newsim->appendStmtMask(getStmtMask());
	newsim->castTo(getCast(), this->getCastStmtMask());
	return newsim;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////// StmtFnCallInfo ///////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtFnCallInfo::clone(Context &ctx)
{
	Vector<Stmt *> newargs;
	for(auto &a : args) {
		newargs.push_back(a->clone(ctx));
	}
	Stmt *res = StmtFnCallInfo::create(ctx, getLoc(), newargs);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtExpr /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtExpr::clone(Context &ctx)
{
	StmtExpr *newexpr =
	StmtExpr::create(ctx, getLoc(), commas, lhs ? lhs->clone(ctx) : nullptr, oper,
			 rhs ? rhs->clone(ctx) : nullptr, is_intrinsic_call);
	newexpr->or_blk	    = or_blk ? as<StmtBlock>(or_blk->clone(ctx)) : nullptr;
	newexpr->or_blk_var = or_blk_var;
	newexpr->calledfn   = calledfn;
	newexpr->appendStmtMask(getStmtMask());
	newexpr->castTo(getCast(), this->getCastStmtMask());
	return newexpr;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtVar //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtVar::clone(Context &ctx)
{
	StmtType *newvtype = vtype ? as<StmtType>(vtype->clone(ctx)) : nullptr;
	Stmt *newvval	   = vval ? vval->clone(ctx) : nullptr;
	StmtVar *res	   = StmtVar::create(ctx, getLoc(), name, newvtype, newvval, varmask);
	res->setAppliedModuleID(applied_module_id);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtFnSig ////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtFnSig::clone(Context &ctx)
{
	Vector<StmtVar *> newargs;
	for(auto &a : args) {
		newargs.push_back(as<StmtVar>(a->clone(ctx)));
	}
	StmtType *newrettype = rettype ? as<StmtType>(rettype->clone(ctx)) : nullptr;
	Stmt *res	     = StmtFnSig::create(ctx, getLoc(), newargs, newrettype, has_variadic);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtFnDef ////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtFnDef::clone(Context &ctx)
{
	StmtFnSig *newsig = as<StmtFnSig>(sig->clone(ctx));
	StmtBlock *newblk = blk ? as<StmtBlock>(blk->clone(ctx)) : nullptr;
	Stmt *res	  = StmtFnDef::create(ctx, getLoc(), newsig, newblk, is_inline);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// StmtHeader /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtHeader::clone(Context &ctx)
{
	Stmt *res = StmtHeader::create(ctx, getLoc(), names, flags);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtLib //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtLib::clone(Context &ctx)
{
	Stmt *res = StmtLib::create(ctx, getLoc(), flags);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// StmtExtern /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtExtern::clone(Context &ctx)
{
	StmtHeader *newheaders = headers ? as<StmtHeader>(headers->clone(ctx)) : nullptr;
	StmtLib *newlibs       = libs ? as<StmtLib>(libs->clone(ctx)) : nullptr;
	Stmt *newent	       = entity->clone(ctx);
	Stmt *res = StmtExtern::create(ctx, getLoc(), fname, newheaders, newlibs, newent);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////// StmtEnum //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtEnum::clone(Context &ctx)
{
	StmtType *newty = tagty;
	if(newty) newty = as<StmtType>(newty->clone(ctx));
	Stmt *res = StmtEnum::create(ctx, getLoc(), items, newty);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////// StmtStruct //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtStruct::clone(Context &ctx)
{
	Vector<StmtVar *> newfields;
	for(auto &f : fields) {
		newfields.push_back(as<StmtVar>(f->clone(ctx)));
	}
	Stmt *res = StmtStruct::create(ctx, getLoc(), newfields, templates, is_decl);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////// StmtVarDecl /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtVarDecl::clone(Context &ctx)
{
	Vector<StmtVar *> newdecls;
	for(auto &d : decls) {
		newdecls.push_back(as<StmtVar>(d->clone(ctx)));
	}
	Stmt *res = StmtVarDecl::create(ctx, getLoc(), newdecls);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtCond /////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtCond::clone(Context &ctx)
{
	Vector<Conditional> newconds;
	for(auto &c : conds) {
		Stmt *newcond	  = c.getCond() ? c.getCond()->clone(ctx) : nullptr;
		StmtBlock *newblk = as<StmtBlock>(c.getBlk()->clone(ctx));
		newconds.push_back(Conditional(newcond, newblk));
	}
	Stmt *res = StmtCond::create(ctx, getLoc(), newconds, is_inline);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtFor //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtFor::clone(Context &ctx)
{
	Stmt *newinit	  = init ? init->clone(ctx) : nullptr;
	Stmt *newcond	  = cond ? cond->clone(ctx) : nullptr;
	Stmt *newincr	  = incr ? incr->clone(ctx) : nullptr;
	StmtBlock *newblk = blk ? as<StmtBlock>(blk->clone(ctx)) : nullptr;
	Stmt *res = StmtFor::create(ctx, getLoc(), newinit, newcond, newincr, newblk, is_inline);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtRet //////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtRet::clone(Context &ctx)
{
	Stmt *newval = val ? val->clone(ctx) : nullptr;
	StmtRet *res = StmtRet::create(ctx, getLoc(), newval);
	res->setFnBlk(fnblk);
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// StmtContinue ///////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtContinue::clone(Context &ctx)
{
	Stmt *res = StmtContinue::create(ctx, getLoc());
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtBreak ////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtBreak::clone(Context &ctx)
{
	Stmt *res = StmtBreak::create(ctx, getLoc());
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// StmtDefer ////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

Stmt *StmtDefer::clone(Context &ctx)
{
	Stmt *res = StmtDefer::create(ctx, getLoc(), val->clone(ctx));
	res->appendStmtMask(getStmtMask());
	res->castTo(getCast(), this->getCastStmtMask());
	return res;
}

} // namespace sc